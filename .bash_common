# -*- coding: utf-8 -*-
export CLICOLOR=1
export ARCHFLAGS='-arch x86_64'

alias cp='cp -i'
alias mv='mv -i'
alias rm='rm -i'
alias grep='grep --color'
alias drink='med go'
alias pour='med mkvenv'

# ``drink`` auto-completion
VENV_LIST=()
for venv in `ls /opt/devel`; do
    VENV_LIST=(${VENV_LIST[@]} "${venv/cms_/}")
done
eval "complete -W \"${VENV_LIST[@]}\" drink"

if [ `uname` == 'Darwin' ]; then
    alias ls='ls -G'
else
    alias ls='ls --color'
fi

if [[ `which mvim` ]]; then 
  alias vim='mvim'
  alias vi='mvim'
else
  alias vi='vim'
fi

if [[ `which ipython` ]]; then
  alias python='ipython --colors=Linux --autoindent --color-info --no-banner'
fi


source /usr/local/git/contrib/completion/git-completion.bash
export GIT_PS1_SHOWDIRTYSTATE=1
function get_git_branch()
{
#    __git_ps1 | sed -e "s/(//" -e "s/)//" -e "s/\(.*\)\+/\1/"
    __branch=$(__git_ps1)
    __branch=${__branch//[()]/}
    __branch=${__branch/ /}
    echo "$__branch"
    # git branch 2>/dev/null | grep "^\*" | cut -c3- | sed -e "s|\(.*\)|\1|"
}

# SUPER PS1
function PS1_LABELS() {
    __reset="\[[0m\]"
    LABELS=""
    if [[ $VIRTUAL_ENV ]]; then
        venv_name=`basename $VIRTUAL_ENV`
        venv_name=`echo ${venv_name/cms_/} | tr [:lower:] [:upper:]`

        LABELS="${LABELS}\[[48;5;208m\]"
        LABELS="${LABELS}\[[38;5;232m\]"
        LABELS="$LABELS $venv_name ${__reset} "
    fi

    # Git Branch
    __branch=`get_git_branch`
    if [[ "$__branch" ]]; then
        LABELS="${LABELS}\[[48;5;46m\] "
        LABELS="${LABELS}\[[38;5;232m\]"
        LABELS="${LABELS}${__branch} ${__reset} "
    fi

    export PS1="$LABELS\[[38;5;216m\](\u) \w\[[38;5;196m\] âžœ \[[0m\]"
}

function venv() {
    $SHELL --rcfile $1/bin/activate
    cd $1
}

function mongo_fork() {
    mongod --port 27017 --fork --logpath=/opt/forks/$1/var/mongodb.log --dbpath=/opt/forks/$1/var/
}

function venv_branches() {
    for dir in `ls /opt/devel`; do
        venv_branch=`cat /opt/devel/$dir/src/storyville/.git/HEAD | sed "s|ref: refs/heads/\(.*\)|\1|"`
        venv_name=`echo $dir | tr '[:lower:]' '[:upper:]' | sed "s|CMS_\(.*\)|\1|"`
        
        echo -e "$venv_name [38;5;196mâžœ[0m $venv_branch"
    done
}

function dbstopall() {
    ctl=`pg_config --bindir`/pg_ctl
    for venv in `ls /opt/devel/`; do
        pg_path="/opt/devel/$venv/var/postgres"

        venv=`echo "$venv" | tr '[:lower:]' '[:upper:]'`
        venv=${venv/CMS_/} 
        echo "STOPPING $venv"
        $ctl stop -m fast -l "$pg_path/logs/postgres.log" -D "$pg_path/data"
        echo ""
    done
}

function dbstartall() {
    echo "What is the matter with? Don't do that...just use med"
}

function range_review()
{
    if [ "$1" == "last" ]; then
        last_num=`expr $2 + 1`
        start=`git log -${last_num} | grep "commit " | sed -e "s/commit //" | tail -1`
        end=`git log -${last_num} | grep "commit " | sed -e "s/commit //" | head -1`
        start_end="$start:$end"

        branch=`git branch | grep "* " | sed -e "s/* //"`
        pr_cmd="post-review -o --branch=$branch --guess-description --tracking-branch=origin/$branch --revision_range=$start:$end"

        if [ "$3" == "for" ]; then
            pr_cmd="$pr_cmd -r $4"
        fi

        echo "Going to execute: $pr_cmd"
        read -p "Ok (y/n)? " GO_YN
        GO_YN=`echo $GO_YN | tr '[:upper:]' '[:lower:]'`
        if [ "$GO_YN" == "y" ]; then
            $pr_cmd
        fi
    else
        echo "THIS IS FOR REVISION RANGES ONLY"
    fi
}

export PS1="\[[38;5;216m\](\u) \w\[[38;5;196m\] âžœ \[[0m\]"
export PROMPT_COMMAND="PS1_LABELS"
